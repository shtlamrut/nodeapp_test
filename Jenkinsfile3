pipeline {
     agent {
        kubernetes {
            yamlFile 'jenkins.yaml'
        }
    }
     environment {
		 dockerhub=credentials('dockerhublogin')
     }		 

     stages {     
         stage('Docker build and tag') {
            steps {
				        container ('docker') {
                    sh 'docker build -t jenkins:latest .' 
                    sh 'docker tag jenkins shtlamrut/jenkins:$BUILD_NUMBER'
				          	sh 'echo $dockerhub_PSW | docker login -u $dockerhub_USR --password-stdin'
					          sh 'docker push docker.io/shtlamrut/jenkins:$BUILD_NUMBER'
                    sh 'docker logout'
                }
            }
         }
         stage('Trigger manifest update') {
		        steps {	 
			          container('kubectl') {
		//sh 'sleep 5m'
                sh 'kubectl apply -f ./deploymentservice.yaml'
                }
           }
		 }  
	}	 
} 
